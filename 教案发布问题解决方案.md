# 教案发布问题解决方案

## 问题描述

**现象**：教师端已经设计了测试题目，但是学生端不显示

**根本原因**：教案还处于草稿（draft）状态，没有发布

---

## 系统工作机制

### 1. 教案状态说明

教案有三种状态：

- **draft（草稿）**：教师正在编辑的状态，学生看不到
- **published（已发布）**：已发布给学生学习的状态，学生可以看到
- **archived（已归档）**：已归档的教案

### 2. 权限过滤机制

```
教师端（编辑/预览）：
✓ 可以看到所有自己创建的教案（包括草稿）
✓ 可以在"预览模式"或"沉浸式预览"中查看内容
✓ 预览功能仅用于教师检查内容，不代表学生能看到

学生端：
✓ 只能看到已发布（published）状态的教案
✗ 看不到草稿状态的教案
✗ 看不到其他教师的私有教案
```

### 3. 为什么会出现这个问题

1. 教师创建教案时，默认状态是 **draft（草稿）**
2. 教师在"沉浸式预览"中可以看到测试题目（因为是自己创建的）
3. 但学生端 API 会自动过滤掉所有草稿状态的教案
4. 因此学生看到的是空白内容

---

## 解决方案

### 方法一：通过界面发布（推荐）⭐

#### 步骤1：进入教案编辑页面

1. 登录教师端
2. 在教案列表中找到"测试activate 模块"
3. 点击"编辑"按钮进入编辑器

#### 步骤2：发布教案

在教案编辑器页面的右上角，你会看到：

```
[保存] [发布] [预览模式] [全屏预览]
```

- 找到绿色的 **"发布"** 按钮
- 点击发布
- 等待提示"教案已发布"

#### 步骤3：验证

1. 切换到学生端账号（或使用学生账号登录）
2. 刷新页面
3. 进入"测试activate 模块"
4. 现在应该能看到测试题目和所有内容了

---

### 方法二：使用脚本批量发布

如果你有多个教案需要发布，可以使用系统提供的批量发布脚本：

```bash
cd /Users/382241106qq.com/inspireed-platform-main/backend
python scripts/publish_test_lessons.py
```

这个脚本会：
- 查找所有草稿状态的教案
- 批量将它们的状态改为"已发布"
- 显示发布结果

---

## 教案发布流程建议

### 标准发布流程

```
1. 创建教案（状态：draft）
   ↓
2. 添加内容（文本、视频、活动等）
   ↓
3. 预览检查（使用"预览模式"或"沉浸式预览"）
   ↓
4. 点击"发布"（状态：draft → published）
   ↓
5. 学生可见
```

### 发布前检查清单

在点击"发布"按钮之前，建议检查以下内容：

- [ ] 教案标题和描述是否完整
- [ ] 所有必需的内容单元是否已添加
- [ ] 测试题目是否正确设置
- [ ] 题目答案和评分标准是否配置好
- [ ] 在预览模式下检查学生视角
- [ ] 所有多媒体资源（图片、视频）是否正常加载

---

## 常见问题 FAQ

### Q1: 发布后还能修改吗？

**答**：可以修改，但建议谨慎操作：

1. 已发布的教案可以继续编辑
2. 修改会立即对学生可见
3. 如果需要大幅修改，建议先取消发布（变回草稿）
4. 系统有"取消发布"按钮，用于将教案变回草稿状态

### Q2: 如何查看教案的当前状态？

**方法1：在教案列表中查看**
- 草稿：显示灰色标签 "草稿"
- 已发布：显示绿色标签 "已发布"

**方法2：在编辑器中查看**
- 如果右上角有"发布"按钮 → 当前是草稿
- 如果右上角有"取消发布"按钮 → 当前是已发布

### Q3: 学生能看到所有已发布的教案吗？

**答**：不是。学生能看到的教案取决于：

1. **发布状态**：必须是"已发布"状态
2. **课程权限**：学生需要有访问该课程的权限
3. **可见性设置**：部分教案可能有额外的可见性限制

### Q4: 为什么教师预览能看到，学生却看不到？

**答**：这是系统的设计机制：

- **教师预览**：是教师端的功能，允许教师查看草稿内容
- **学生查看**：通过学生端API，只返回已发布的教案
- 两者使用的是不同的数据查询逻辑

---

## 技术细节（供开发者参考）

### 后端API权限过滤

在 `backend/app/api/v1/lessons.py` 中：

```python
# 根据用户角色应用不同的过滤条件
if current_user.role == "student":
    # 学生：只能看到已发布的课程
    query = query.where(Lesson.status == LessonStatus.PUBLISHED)
else:
    # 教师/管理员/教研员：只能看到自己创建的课程
    query = query.where(Lesson.creator_id == current_user.id)
```

### 发布API

发布教案的API端点：

```
POST /api/v1/lessons/{lesson_id}/publish
```

取消发布的API端点：

```
POST /api/v1/lessons/{lesson_id}/unpublish
```

### 数据库字段

教案表（lessons）中的相关字段：

```sql
status VARCHAR  -- 'draft' | 'published' | 'archived'
published_at TIMESTAMP  -- 发布时间（首次发布时设置）
updated_at TIMESTAMP  -- 最后更新时间
```

---

## 总结

**核心要点**：

1. ✅ 教案创建后默认是草稿状态
2. ✅ 必须点击"发布"按钮才能让学生看到
3. ✅ 教师预览 ≠ 学生可见
4. ✅ 发布后可以继续编辑，修改立即生效

**一句话解决方案**：

> 在教案编辑器右上角点击绿色的"发布"按钮即可。

---

## 相关文档

- [教案管理指南](docs/README.md)
- [活动模块使用指南](QUICK_START_ACTIVITY_MODULE.md)
- [完整功能说明](README.md)

---

*最后更新：2025-11-08*

