<template>
  <div v-if="show" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold">ç»Ÿä¸€æ•°æ®å¯¼å…¥</h3>
        <button @click="close" class="text-gray-400 hover:text-gray-600">
          <span class="text-2xl">&times;</span>
        </button>
      </div>

      <!-- æ­¥éª¤æŒ‡ç¤ºå™¨ -->
      <div class="mb-6">
        <div class="flex items-center justify-center space-x-4">
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                 :class="currentStep >= 1 ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600'">
              1
            </div>
            <span class="ml-2 text-sm font-medium">ä¸‹è½½æ¨¡æ¿</span>
          </div>
          <div class="w-8 h-0.5 bg-gray-300"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                 :class="currentStep >= 2 ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600'">
              2
            </div>
            <span class="ml-2 text-sm font-medium">ä¸Šä¼ æ–‡ä»¶</span>
          </div>
          <div class="w-8 h-0.5 bg-gray-300"></div>
          <div class="flex items-center">
            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium"
                 :class="currentStep >= 3 ? 'bg-blue-600 text-white' : 'bg-gray-300 text-gray-600'">
              3
            </div>
            <span class="ml-2 text-sm font-medium">ç¡®è®¤å¯¼å…¥</span>
          </div>
        </div>
      </div>

      <!-- æ­¥éª¤1: ä¸‹è½½æ¨¡æ¿ -->
      <div v-if="currentStep === 1" class="space-y-4">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <h4 class="font-medium text-blue-900 mb-2">ğŸ“‹ ç»Ÿä¸€å¯¼å…¥è¯´æ˜</h4>
          <ul class="text-sm text-blue-800 space-y-1">
            <li>â€¢ <strong>ä¸€æ¬¡å¯¼å…¥ï¼Œå®Œæˆæ‰€æœ‰æ“ä½œ</strong>ï¼šåˆ›å»ºç”¨æˆ·ã€æ›´æ–°ç”¨æˆ·ä¿¡æ¯ã€æ·»åŠ åˆ°ç­çº§</li>
            <li>â€¢ æ”¯æŒ CSV å’Œ Excel æ ¼å¼æ–‡ä»¶ï¼ˆ.csv, .xlsx, .xlsï¼‰ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡5MB</li>
            <li>â€¢ <strong>å­¦ç±å·ï¼ˆæ¨èï¼‰</strong>ï¼šå”¯ä¸€æ ‡è¯†ï¼Œç”¨äºåŒ¹é…å·²å­˜åœ¨çš„ç”¨æˆ·</li>
            <li>â€¢ å¦‚æœç”¨æˆ·ä¸å­˜åœ¨ï¼Œç³»ç»Ÿä¼šæ ¹æ®å­¦å·/ç”¨æˆ·åã€é‚®ç®±ã€å§“ååˆ›å»ºæ–°ç”¨æˆ·ï¼ˆéœ€è¦æä¾›å¯†ç ï¼‰</li>
            <li>â€¢ å¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼Œç³»ç»Ÿä¼šæ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼ˆå¯†ç å¯é€‰ï¼‰</li>
            <li>â€¢ å¦‚æœæä¾›äº†ç­çº§IDï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ç”¨æˆ·æ·»åŠ åˆ°ç­çº§</li>
            <li>â€¢ <strong>ç»„ç»‡æ¶æ„IDè·å–</strong>ï¼šåŒºåŸŸIDã€å­¦æ ¡IDã€å¹´çº§IDã€ç­çº§IDè¯·åœ¨"ç»„ç»‡æ¶æ„ç®¡ç†"é¡µé¢æŸ¥çœ‹ï¼ˆè§ä¸‹æ–¹è¯´æ˜ï¼‰</li>
            <li>â€¢ è§’è‰²å¯é€‰å€¼ï¼šç®¡ç†å‘˜ã€æ•™ç ”å‘˜ã€æ•™å¸ˆã€å­¦ç”Ÿ</li>
            <li>â€¢ ç­çº§è§’è‰²å¯é€‰å€¼ï¼šå­¦ç”Ÿã€æ­£ç­ä¸»ä»»ã€å‰¯ç­ä¸»ä»»ã€ä»»è¯¾æ•™å¸ˆã€ç­å¹²éƒ¨</li>
          </ul>
        </div>
        
        <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
          <h4 class="font-medium text-gray-900 mb-2">æ¨¡æ¿å­—æ®µè¯´æ˜</h4>
          <div class="text-sm text-gray-700 space-y-2">
            <div>
              <strong>å¿…éœ€å­—æ®µï¼ˆåˆ›å»ºæ–°ç”¨æˆ·æ—¶ï¼‰ï¼š</strong>
              <div class="mt-1 font-mono text-xs bg-white p-2 rounded border">
                å­¦å·/ç”¨æˆ·å, é‚®ç®±, å¯†ç 
              </div>
            </div>
            <div>
              <strong>ç”¨æˆ·åŒ¹é…å­—æ®µï¼ˆè‡³å°‘æä¾›ä¸€ä¸ªï¼‰ï¼š</strong>
              <div class="mt-1 font-mono text-xs bg-white p-2 rounded border">
                å­¦ç±å·ï¼ˆæ¨èï¼‰, å­¦å·/ç”¨æˆ·å, é‚®ç®±, å§“å
              </div>
            </div>
            <div>
              <strong>å®Œæ•´å­—æ®µåˆ—è¡¨ï¼š</strong>
              <div class="mt-1 font-mono text-xs bg-white p-2 rounded border">
                å­¦ç±å·, å­¦å·/ç”¨æˆ·å, å§“å, é‚®ç®±, å¯†ç , è§’è‰², æ˜¯å¦æ¿€æ´», åŒºåŸŸID, å­¦æ ¡ID, å¹´çº§ID, ç­çº§ID, åº§å·, ç­çº§è§’è‰², èŒåŠ¡åç§°, ä¸»ç­çº§, ç­çº§å­¦å·
              </div>
              <p class="mt-1 text-xs text-gray-600">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>ç»„ç»‡æ¶æ„IDï¼ˆåŒºåŸŸIDã€å­¦æ ¡IDã€å¹´çº§IDã€ç­çº§IDï¼‰ä¸ºå¯é€‰å­—æ®µï¼Œè¯¦è§ä¸‹æ–¹çš„"ç»„ç»‡æ¶æ„IDè·å–æ–¹å¼"è¯´æ˜
              </p>
            </div>
          </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <h4 class="font-medium text-yellow-900 mb-2">ğŸ“Œ ç»„ç»‡æ¶æ„IDè·å–æ–¹å¼</h4>
          <div class="text-sm text-yellow-800 space-y-3">
            <p><strong>åŒºåŸŸIDã€å­¦æ ¡IDã€å¹´çº§IDã€ç­çº§ID</strong>ç­‰ç»„ç»‡æ¶æ„ä¿¡æ¯å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–ï¼š</p>
            
            <div>
              <p class="font-semibold mb-1">1. åŒºåŸŸIDã€å­¦æ ¡IDã€ç­çº§IDï¼š</p>
              <ul class="list-disc list-inside space-y-1 ml-2 text-xs">
                <li>è®¿é—® <strong>ç®¡ç†å‘˜åå° â†’ ç»„ç»‡æ¶æ„ç®¡ç†</strong> é¡µé¢</li>
                <li>åœ¨ç»„ç»‡æ¶æ„ç®¡ç†é¡µé¢ä¸­ï¼Œ<strong>æ¯ä¸ªç»„ç»‡å•ä½çš„IDä¼šæ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­</strong>ï¼ˆé€šå¸¸åœ¨è¡¨æ ¼çš„ç¬¬ä¸€åˆ—æˆ–è¯¦æƒ…é¡µé¢ï¼‰</li>
                <li><strong>ç­çº§IDè¯´æ˜ï¼š</strong>
                  <div class="mt-1 ml-4 p-2 bg-white rounded border border-blue-200 text-xs">
                    â€¢ ç­çº§IDæ˜¯æ•°æ®åº“ä¸­çš„æ•°å­—IDï¼Œéœ€è¦åœ¨ç»„ç»‡æ¶æ„ç®¡ç†é¡µé¢çš„ç­çº§åˆ—è¡¨ä¸­æŸ¥çœ‹<br/>
                    â€¢ ç­çº§ç¼–ç ï¼ˆcodeï¼‰æ ¼å¼ä¸º"å…¥å­¦å¹´ä»½+ç­çº§ç¼–å·"ï¼Œä¾‹å¦‚ï¼š202501ï¼ˆè¡¨ç¤º2025å¹´å…¥å­¦çš„01ç­ï¼‰<br/>
                    â€¢ <strong>å¯¼å…¥æ—¶å¡«å†™çš„æ˜¯ç­çº§IDï¼ˆæ•°å­—ï¼‰ï¼Œä¸æ˜¯ç­çº§ç¼–ç </strong><br/>
                    â€¢ ç­çº§ç¼–ç ä»…ç”¨äºæ˜¾ç¤ºå’Œè¯†åˆ«ï¼Œä¸èƒ½ç”¨ä½œå¯¼å…¥æ—¶çš„ID
                  </div>
                </li>
              </ul>
            </div>
            
            <div>
              <p class="font-semibold mb-1">2. å¹´çº§IDï¼ˆé‡è¦ï¼‰ï¼š</p>
              <ul class="list-disc list-inside space-y-1 ml-2 text-xs">
                <li>æ–¹æ³•ä¸€ï¼šè®¿é—® <strong>ç®¡ç†å‘˜åå° â†’ è¯¾ç¨‹ç®¡ç†</strong> é¡µé¢ï¼Œåœ¨è¯¾ç¨‹æ ‘ç»“æ„ä¸­å¯ä»¥çœ‹åˆ°å¹´çº§ä¿¡æ¯</li>
                <li>æ–¹æ³•äºŒï¼šåœ¨ <strong>ç»„ç»‡æ¶æ„ç®¡ç† â†’ åˆ›å»º/ç¼–è¾‘ç­çº§</strong> æ—¶ï¼Œå¹´çº§ä¸‹æ‹‰é€‰æ‹©æ¡†ä¸­ä¼šæ˜¾ç¤º"å¹´çº§åç§° (ID: å¹´çº§ID)"æ ¼å¼ï¼Œå¯ç›´æ¥çœ‹åˆ°å¹´çº§ID</li>
                <li>æ–¹æ³•ä¸‰ï¼šç³»ç»Ÿæ ‡å‡†å¹´çº§IDå¯¹åº”å…³ç³»ï¼ˆæŒ‰é¡ºåºé€’å¢ï¼‰ï¼š
                  <div class="mt-1 ml-4 p-2 bg-white rounded border border-yellow-200 text-xs">
                    <div class="font-mono space-y-0.5">
                      <div>ä¸€å¹´çº§ â†’ ID: 1 | äºŒå¹´çº§ â†’ ID: 2 | ä¸‰å¹´çº§ â†’ ID: 3</div>
                      <div>å››å¹´çº§ â†’ ID: 4 | äº”å¹´çº§ â†’ ID: 5 | å…­å¹´çº§ â†’ ID: 6</div>
                      <div>ä¸ƒå¹´çº§ â†’ ID: 7 | å…«å¹´çº§ â†’ ID: 8 | ä¹å¹´çº§ â†’ ID: 9</div>
                      <div>é«˜ä¸€ â†’ ID: 10 | é«˜äºŒ â†’ ID: 11 | é«˜ä¸‰ â†’ ID: 12</div>
                      <div>æœªåˆ†ç±» â†’ ID: 13</div>
                    </div>
                    <div class="text-gray-600 mt-2 text-xs">ğŸ’¡ æç¤ºï¼šå¹´çº§IDä»1å¼€å§‹æŒ‰é¡ºåºé€’å¢ï¼Œä¸å¹´çº§çº§åˆ«ï¼ˆlevelï¼‰åŸºæœ¬ä¸€è‡´</div>
                  </div>
                </li>
              </ul>
            </div>
            
            <div class="mt-2 p-2 bg-white rounded border border-yellow-300">
              <p class="text-xs font-semibold mb-1"><strong>IDç¤ºä¾‹ï¼š</strong></p>
              <p class="text-xs">åŒºåŸŸID: 1 | å­¦æ ¡ID: 101 | å¹´çº§ID: 3ï¼ˆä¸‰å¹´çº§ï¼‰| ç­çº§ID: 5ï¼ˆæ•°æ®åº“æ•°å­—IDï¼‰</p>
              <p class="text-xs text-gray-600 mt-1">
                ğŸ’¡ <strong>æç¤ºï¼š</strong>è¿™äº›å­—æ®µä¸º<strong>å¯é€‰å­—æ®µ</strong>ï¼Œå¦‚æœç”¨æˆ·ä¸å±äºç‰¹å®šç»„ç»‡ï¼Œå¯ä»¥ç•™ç©º<br/>
                ğŸ’¡ <strong>æ³¨æ„ï¼š</strong>ç­çº§IDæ˜¯æ•°æ®åº“ä¸­çš„æ•°å­—IDï¼ˆå¦‚ï¼š5ï¼‰ï¼Œä¸æ˜¯ç­çº§ç¼–ç ï¼ˆå¦‚ï¼š202501ï¼‰ï¼Œè¯·åœ¨"ç»„ç»‡æ¶æ„ç®¡ç†"é¡µé¢æŸ¥çœ‹ç­çº§ID
              </p>
            </div>
          </div>
        </div>
        
        <div class="flex justify-center">
          <button
            @click="downloadTemplate"
            class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 flex items-center"
          >
            <span class="mr-2">ğŸ“¥</span>
            ä¸‹è½½ç»Ÿä¸€å¯¼å…¥æ¨¡æ¿
          </button>
        </div>
        
        <div class="text-center">
          <button
            @click="currentStep = 2"
            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
          >
            ä¸‹ä¸€æ­¥
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤2: ä¸Šä¼ æ–‡ä»¶ -->
      <div v-if="currentStep === 2" class="space-y-4">
        <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center">
          <input
            ref="fileInputRef"
            type="file"
            accept=".csv,.xlsx,.xls"
            @change="handleFileSelect"
            class="hidden"
          />
          <div v-if="!selectedFile" @click="triggerFileSelect" class="cursor-pointer">
            <div class="text-4xl mb-4">ğŸ“</div>
            <p class="text-lg font-medium text-gray-700">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <p class="text-sm text-gray-500 mt-2">æ”¯æŒ CSV æˆ– Excel æ–‡ä»¶ï¼ˆ.csv, .xlsx, .xlsï¼‰</p>
            <p class="text-sm text-gray-500">æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤åŒºåŸŸ</p>
          </div>
          <div v-else class="text-center">
            <div class="text-4xl mb-4">âœ…</div>
            <p class="text-lg font-medium text-green-700">{{ selectedFile.name }}</p>
            <p class="text-sm text-gray-500 mt-2">æ–‡ä»¶å¤§å°: {{ formatFileSize(selectedFile.size) }}</p>
            <button
              @click="resetSelectedFile"
              class="mt-2 text-sm text-red-600 hover:text-red-800"
            >
              é‡æ–°é€‰æ‹©
            </button>
          </div>
        </div>
        
        <div class="flex justify-between">
          <button
            @click="currentStep = 1"
            class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
          >
            ä¸Šä¸€æ­¥
          </button>
          <button
            @click="currentStep = 3"
            :disabled="!selectedFile"
            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            ä¸‹ä¸€æ­¥
          </button>
        </div>
      </div>

      <!-- æ­¥éª¤3: ç¡®è®¤å¯¼å…¥ -->
      <div v-if="currentStep === 3" class="space-y-4">
        <div v-if="importing" class="text-center py-8">
          <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
          <p class="text-gray-600">æ­£åœ¨å¯¼å…¥æ•°æ®ï¼Œè¯·ç¨å€™...</p>
        </div>
        
        <div v-else-if="importResult" class="space-y-4">
          <div class="bg-green-50 border border-green-200 rounded-lg p-4">
            <h4 class="font-medium text-green-900 mb-2">âœ… å¯¼å…¥å®Œæˆ</h4>
            <p class="text-sm text-green-800">
              {{ importResult.message }}
            </p>
            <p class="text-sm text-green-700 mt-2">
              æˆåŠŸ: {{ importResult.success_count }} ä¸ªï¼Œå¤±è´¥: {{ importResult.error_count }} ä¸ª
            </p>
            <p class="text-sm text-green-700">
              åˆ›å»º/æ›´æ–°ç”¨æˆ·: {{ importResult.created_user_count }} ä¸ªï¼Œæ·»åŠ åˆ°ç­çº§: {{ importResult.added_member_count }} ä¸ª
            </p>
          </div>
          
          <div v-if="importResult.errors.length > 0" class="bg-red-50 border border-red-200 rounded-lg p-4">
            <h4 class="font-medium text-red-900 mb-2">âŒ å¯¼å…¥é”™è¯¯</h4>
            <div class="max-h-32 overflow-y-auto">
              <ul class="text-sm text-red-800 space-y-1">
                <li v-for="error in importResult.errors" :key="error">â€¢ {{ error }}</li>
              </ul>
            </div>
          </div>
          
          <div v-if="importResult.created_users.length > 0" class="bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h4 class="font-medium text-blue-900 mb-2">ğŸ‘¥ åˆ›å»º/æ›´æ–°çš„ç”¨æˆ·</h4>
            <div class="max-h-32 overflow-y-auto">
              <ul class="text-sm text-blue-800 space-y-1">
                <li v-for="user in importResult.created_users" :key="user.id">
                  â€¢ {{ user.username }} ({{ user.email }}) - {{ getRoleDisplayName(user.role) }}
                </li>
              </ul>
            </div>
          </div>
          
          <div v-if="importResult.added_members.length > 0" class="bg-purple-50 border border-purple-200 rounded-lg p-4">
            <h4 class="font-medium text-purple-900 mb-2">ğŸ« æ·»åŠ åˆ°ç­çº§çš„æˆå‘˜</h4>
            <div class="max-h-32 overflow-y-auto">
              <ul class="text-sm text-purple-800 space-y-1">
                <li v-for="member in importResult.added_members" :key="`${member.user_id}-${member.classroom_id}`">
                  â€¢ {{ member.username }} ({{ member.full_name || 'æœªè®¾ç½®å§“å' }}) â†’ {{ member.classroom_name || `ç­çº§${member.classroom_id}` }}
                </li>
              </ul>
            </div>
          </div>
        </div>
        
        <div v-else class="space-y-4">
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
            <h4 class="font-medium text-yellow-900 mb-2">âš ï¸ ç¡®è®¤å¯¼å…¥</h4>
            <p class="text-sm text-yellow-800">
              å³å°†å¯¼å…¥æ–‡ä»¶ <strong>{{ selectedFile?.name }}</strong> ä¸­çš„æ•°æ®ã€‚
            </p>
            <p class="text-sm text-yellow-800 mt-2">
              ç³»ç»Ÿå°†è‡ªåŠ¨ï¼šåˆ›å»ºæ–°ç”¨æˆ·ã€æ›´æ–°å·²å­˜åœ¨ç”¨æˆ·ã€æ·»åŠ åˆ°ç­çº§ï¼ˆå¦‚æœæä¾›äº†ç­çº§IDï¼‰ã€‚
            </p>
          </div>
          
          <div class="flex justify-between">
            <button
              @click="currentStep = 2"
              class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
            >
              ä¸Šä¸€æ­¥
            </button>
            <button
              @click="startImport"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
            >
              å¼€å§‹å¯¼å…¥
            </button>
          </div>
        </div>
        
        <div v-if="importResult" class="text-center">
          <button
            @click="close"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
          >
            å®Œæˆ
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue'
import { useToast } from '@/composables/useToast'
import adminService, { type UnifiedImportItem, type UnifiedImportResult } from '@/services/admin'
import * as XLSX from 'xlsx'
import GBK from 'gbk.js'

const props = defineProps<{
  show: boolean
}>()

const emit = defineEmits<{
  close: []
  success: []
}>()

const toast = useToast()

// å“åº”å¼æ•°æ®
const currentStep = ref(1)
const selectedFile = ref<File | null>(null)
const importing = ref(false)
const importResult = ref<UnifiedImportResult | null>(null)
const fileInputRef = ref<HTMLInputElement | null>(null)

const HEADER_MAP: Record<string, string | null> = {
  // ç”¨æˆ·æ ‡è¯†å­—æ®µ
  student_id_number: 'student_id_number',
  å­¦ç±å·: 'student_id_number',
  å­¦ç±ç¼–å·: 'student_id_number',
  username: 'username',
  ç”¨æˆ·å: 'username',
  'å­¦å·/ç”¨æˆ·å': 'username',
  å­¦å·: 'username',
  email: 'email',
  é‚®ç®±: 'email',
  full_name: 'full_name',
  å§“å: 'full_name',
  name: 'full_name',
  // ç”¨æˆ·åˆ›å»º/æ›´æ–°å­—æ®µ
  password: 'password',
  å¯†ç : 'password',
  role: 'role',
  è§’è‰²: 'role',
  is_active: 'is_active',
  'æ˜¯å¦æ¿€æ´»': 'is_active',
  'æ¿€æ´»çŠ¶æ€': 'is_active',
  // ç»„ç»‡ä¿¡æ¯
  region_id: 'region_id',
  'åŒºåŸŸID': 'region_id',
  'åŒºåŸŸID(å¯é€‰)': 'region_id',
  school_id: 'school_id',
  'å­¦æ ¡ID': 'school_id',
  'å­¦æ ¡ID(å¯é€‰)': 'school_id',
  grade_id: 'grade_id',
  'å¹´çº§ID': 'grade_id',
  'å¹´çº§ID(å¯é€‰)': 'grade_id',
  classroom_id: 'classroom_id',
  'ç­çº§ID': 'classroom_id',
  'ç­çº§ID(å¯é€‰)': 'classroom_id',
  // ç­çº§æˆå‘˜ä¿¡æ¯
  seat_no: 'seat_no',
  åº§å·: 'seat_no',
  role_in_class: 'role_in_class',
  ç­çº§è§’è‰²: 'role_in_class',
  è§’è‰²: 'role_in_class',
  cadre_title: 'cadre_title',
  èŒåŠ¡åç§°: 'cadre_title',
  èŒåŠ¡: 'cadre_title',
  is_primary_class: 'is_primary_class',
  ä¸»ç­çº§: 'is_primary_class',
  student_no: 'student_no',
  ç­çº§å­¦å·: 'student_no',
  å¤‡æ³¨: null,
  è¯´æ˜: null,
  remark: null,
}

const ROLE_MAP: Record<string, string> = {
  admin: 'admin',
  ç®¡ç†å‘˜: 'admin',
  teacher: 'teacher',
  æ•™å¸ˆ: 'teacher',
  student: 'student',
  å­¦ç”Ÿ: 'student',
  researcher: 'researcher',
  æ•™ç ”å‘˜: 'researcher',
}

function normalizeHeader(header: string): string | null {
  const cleaned = header.replace(/^["']|["']$/g, '').trim()
  
  if (Object.prototype.hasOwnProperty.call(HEADER_MAP, cleaned)) {
    return HEADER_MAP[cleaned]
  }
  
  const withoutBrackets = cleaned.replace(/\([^)]*\)/g, '').trim()
  if (withoutBrackets !== cleaned && Object.prototype.hasOwnProperty.call(HEADER_MAP, withoutBrackets)) {
    return HEADER_MAP[withoutBrackets]
  }
  
  return cleaned || null
}

function close() {
  currentStep.value = 1
  selectedFile.value = null
  importResult.value = null
  emit('close')
}

function getRoleDisplayName(role: string): string {
  const roleMap = {
    admin: 'ç®¡ç†å‘˜',
    researcher: 'æ•™ç ”å‘˜',
    teacher: 'æ•™å¸ˆ',
    student: 'å­¦ç”Ÿ'
  }
  return roleMap[role] || role
}

function triggerFileSelect() {
  fileInputRef.value?.click()
}

function resetSelectedFile() {
  selectedFile.value = null
  if (fileInputRef.value) {
    fileInputRef.value.value = ''
  }
}

function formatFileSize(bytes: number): string {
  if (bytes === 0) return '0 Bytes'
  const k = 1024
  const sizes = ['Bytes', 'KB', 'MB', 'GB']
  const i = Math.floor(Math.log(bytes) / Math.log(k))
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
}

async function downloadTemplate() {
  try {
    const result = await adminService.getUnifiedImportTemplate()
    
    const blob = new Blob([result.template], { type: 'text/csv;charset=utf-8;' })
    const link = document.createElement('a')
    const url = URL.createObjectURL(blob)
    link.setAttribute('href', url)
    link.setAttribute('download', result.filename)
    link.style.visibility = 'hidden'
    document.body.appendChild(link)
    link.click()
    document.body.removeChild(link)
    URL.revokeObjectURL(url)
    
    toast.success('æ¨¡æ¿ä¸‹è½½æˆåŠŸ')
  } catch (error: any) {
    console.error('Failed to download template:', error)
    toast.error('ä¸‹è½½æ¨¡æ¿å¤±è´¥')
  }
}

function handleFileSelect(event: Event) {
  const target = event.target as HTMLInputElement
  const file = target.files?.[0]
  
  if (file) {
    const fileName = file.name.toLowerCase()
    const validExtensions = ['.csv', '.xlsx', '.xls']
    const isValidFile = validExtensions.some(ext => fileName.endsWith(ext))
    
    if (!isValidFile) {
      toast.error('è¯·é€‰æ‹© CSV æˆ– Excel æ ¼å¼çš„æ–‡ä»¶ï¼ˆ.csv, .xlsx, .xlsï¼‰')
      return
    }
    
    if (file.size > 5 * 1024 * 1024) {
      toast.error('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡5MB')
      return
    }
    
    selectedFile.value = file
  }
}

function readFileAsText(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    
    reader.onload = async (e) => {
      try {
        const arrayBuffer = e.target?.result as ArrayBuffer
        if (!arrayBuffer) {
          reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'))
          return
        }
        
        try {
          const utf8Text = new TextDecoder('utf-8', { fatal: true }).decode(arrayBuffer)
          const hasReplacementChar = utf8Text.slice(0, 200).includes('\uFFFD')
          const hasChinese = /[\u4e00-\u9fa5]/.test(utf8Text.slice(0, 200))
          const hasGarbledPattern = /[^\u0000-\u007F\u4e00-\u9fa5\sï¼Œã€‚ï¼ï¼Ÿï¼šï¼›""''ï¼ˆï¼‰ã€ã€‘ã€Šã€‹ã€]/.test(utf8Text.slice(0, 200))
          
          if (!hasReplacementChar && (!hasGarbledPattern || hasChinese)) {
            resolve(utf8Text)
            return
          }
        } catch (e) {
          // UTF-8 è§£ç å¤±è´¥ï¼Œç»§ç»­å°è¯• GBK
        }
        
        try {
          const uint8Array = new Uint8Array(arrayBuffer)
          const gbkText = GBK.toString(uint8Array)
          if (/[\u4e00-\u9fa5]/.test(gbkText.slice(0, 200))) {
            resolve(gbkText)
            return
          }
        } catch (gbkError) {
          // GBK è§£ç å¤±è´¥
        }
        
        const utf8Text = new TextDecoder('utf-8', { fatal: false }).decode(arrayBuffer)
        resolve(utf8Text)
      } catch (error: any) {
        reject(new Error(`æ–‡ä»¶è¯»å–å¤±è´¥: ${error.message}`))
      }
    }
    
    reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'))
    reader.readAsArrayBuffer(file)
  })
}

function parseCSVLine(line: string): string[] {
  const result: string[] = []
  let current = ''
  let inQuotes = false
  
  for (let i = 0; i < line.length; i++) {
    const char = line[i]
    
    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"'
        i++
      } else {
        inQuotes = !inQuotes
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim())
      current = ''
    } else {
      current += char
    }
  }
  
  result.push(current.trim())
  return result
}

function parseCSV(csvText: string): UnifiedImportItem[] {
  let text = csvText
  if (text.charCodeAt(0) === 0xFEFF) {
    text = text.slice(1)
  }
  
  const lines = text.trim().split(/\r?\n/).filter(line => line.trim() && !line.trim().startsWith('#'))
  if (lines.length === 0) {
    throw new Error('CSVæ–‡ä»¶ä¸ºç©º')
  }
  
  const firstLine = lines[0]
  const hasTabs = firstLine.includes('\t')
  const delimiter = hasTabs ? '\t' : ','
  
  const parseLine = delimiter === '\t' 
    ? (line: string) => line.split('\t').map(h => h.trim())
    : parseCSVLine
  
  const originalHeaders = parseLine(lines[0]).map(h => h.replace(/^"|"$/g, '').trim())
  const normalizedHeaders = originalHeaders.map(normalizeHeader)
  
  const parseBoolean = (value: string, rowNumber: number) => {
    const normalized = value.trim().toLowerCase()
    if (['true', '1', 'yes', 'y', 'æ˜¯', 'æ¿€æ´»'].includes(normalized)) return true
    if (['false', '0', 'no', 'n', '', 'å¦', 'æœªæ¿€æ´»'].includes(normalized)) return false
    throw new Error(`ç¬¬${rowNumber}è¡Œ is_active åˆ—åªèƒ½å¡«å†™ true/false`)
  }
  
  const parseOptionalNumber = (value: string | undefined, column: string, rowNumber: number) => {
    if (value === undefined || value === null || value === '') {
      return undefined
    }
    const parsed = Number(value)
    if (Number.isNaN(parsed)) {
      throw new Error(`ç¬¬${rowNumber}è¡Œ ${column} åˆ—å¿…é¡»å¡«å†™æ•°å­—IDæˆ–ç•™ç©º`)
    }
    return parsed
  }

  const items: UnifiedImportItem[] = []
  
  for (let i = 1; i < lines.length; i++) {
    const line = lines[i].trim()
    if (!line) continue
    const rowNumber = i + 1
    
    const values = parseLine(line).map(v => v.replace(/^"|"$/g, '').trim())
    if (values.length !== normalizedHeaders.length) {
      throw new Error(`ç¬¬${rowNumber}è¡Œæ•°æ®åˆ—æ•°ä¸åŒ¹é…ï¼ŒæœŸæœ› ${normalizedHeaders.length} åˆ—ï¼Œå®é™… ${values.length} åˆ—`)
    }
    
    const item: any = {}
    normalizedHeaders.forEach((_, index) => {
      const normalizedHeader = normalizeHeader(originalHeaders[index])
      if (!normalizedHeader) {
        return
      }
      item[normalizedHeader] = values[index]
    })
    
    const roleValue = item.role ? String(item.role).trim().toLowerCase() : undefined
    const normalizedRole = roleValue && ROLE_MAP[roleValue] ? ROLE_MAP[roleValue] : undefined

    items.push({
      student_id_number: item.student_id_number ? String(item.student_id_number).trim() : undefined,
      username: item.username ? String(item.username).trim() : undefined,
      email: item.email ? String(item.email).trim() : undefined,
      full_name: item.full_name ? String(item.full_name).trim() : undefined,
      password: item.password ? String(item.password).trim() : undefined,
      role: normalizedRole,
      is_active: item.is_active !== undefined ? parseBoolean(String(item.is_active), rowNumber) : undefined,
      region_id: parseOptionalNumber(item.region_id, 'region_id', rowNumber),
      school_id: parseOptionalNumber(item.school_id, 'school_id', rowNumber),
      grade_id: parseOptionalNumber(item.grade_id, 'grade_id', rowNumber),
      classroom_id: parseOptionalNumber(item.classroom_id, 'classroom_id', rowNumber),
      seat_no: parseOptionalNumber(item.seat_no, 'seat_no', rowNumber),
      role_in_class: item.role_in_class ? String(item.role_in_class).trim() : undefined,
      cadre_title: item.cadre_title ? String(item.cadre_title).trim() : undefined,
      is_primary_class: item.is_primary_class !== undefined ? (String(item.is_primary_class).toLowerCase() === 'true') : undefined,
      student_no: item.student_no ? String(item.student_no).trim() : undefined,
    })
  }
  
  return items
}

async function parseExcel(file: File): Promise<UnifiedImportItem[]> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target?.result as ArrayBuffer)
        const workbook = XLSX.read(data, { type: 'array' })
        
        const firstSheetName = workbook.SheetNames[0]
        const worksheet = workbook.Sheets[firstSheetName]
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 }) as any[][]
        
        if (jsonData.length < 2) {
          throw new Error('Excelæ–‡ä»¶ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®')
        }
        
        const originalHeaders = jsonData[0].map(h => String(h).trim())
        const normalizedHeaders = originalHeaders.map(normalizeHeader)
        
        const parseBoolean = (value: string, rowNumber: number) => {
          const normalized = String(value).trim().toLowerCase()
          if (['true', '1', 'yes', 'y', 'æ˜¯', 'æ¿€æ´»'].includes(normalized)) return true
          if (['false', '0', 'no', 'n', '', 'å¦', 'æœªæ¿€æ´»'].includes(normalized)) return false
          throw new Error(`ç¬¬${rowNumber}è¡Œ is_active åˆ—åªèƒ½å¡«å†™ true/false`)
        }
        
        const parseOptionalNumber = (value: string | undefined, column: string, rowNumber: number) => {
          if (value === undefined || value === null || value === '') {
            return undefined
          }
          const parsed = Number(value)
          if (Number.isNaN(parsed)) {
            throw new Error(`ç¬¬${rowNumber}è¡Œ ${column} åˆ—å¿…é¡»å¡«å†™æ•°å­—IDæˆ–ç•™ç©º`)
          }
          return parsed
        }

        const items: UnifiedImportItem[] = []
        
        for (let i = 1; i < jsonData.length; i++) {
          const row = jsonData[i]
          if (!row || row.length === 0) continue
          const rowNumber = i + 1
          
          const item: any = {}
          normalizedHeaders.forEach((_, index) => {
            const normalizedHeader = normalizeHeader(originalHeaders[index])
            if (!normalizedHeader) {
              return
            }
            item[normalizedHeader] = row[index] !== undefined ? String(row[index]).trim() : ''
          })
          
          const roleValue = item.role ? String(item.role).trim().toLowerCase() : undefined
          const normalizedRole = roleValue && ROLE_MAP[roleValue] ? ROLE_MAP[roleValue] : undefined

          items.push({
            student_id_number: item.student_id_number ? String(item.student_id_number).trim() : undefined,
            username: item.username ? String(item.username).trim() : undefined,
            email: item.email ? String(item.email).trim() : undefined,
            full_name: item.full_name ? String(item.full_name).trim() : undefined,
            password: item.password ? String(item.password).trim() : undefined,
            role: normalizedRole,
            is_active: item.is_active !== undefined ? parseBoolean(String(item.is_active), rowNumber) : undefined,
            region_id: parseOptionalNumber(item.region_id, 'region_id', rowNumber),
            school_id: parseOptionalNumber(item.school_id, 'school_id', rowNumber),
            grade_id: parseOptionalNumber(item.grade_id, 'grade_id', rowNumber),
            classroom_id: parseOptionalNumber(item.classroom_id, 'classroom_id', rowNumber),
            seat_no: parseOptionalNumber(item.seat_no, 'seat_no', rowNumber),
            role_in_class: item.role_in_class ? String(item.role_in_class).trim() : undefined,
            cadre_title: item.cadre_title ? String(item.cadre_title).trim() : undefined,
            is_primary_class: item.is_primary_class !== undefined ? (String(item.is_primary_class).toLowerCase() === 'true') : undefined,
            student_no: item.student_no ? String(item.student_no).trim() : undefined,
          })
        }
        
        if (items.length === 0) {
          throw new Error('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ•°æ®')
        }
        
        resolve(items)
      } catch (error: any) {
        reject(new Error(`è§£æExcelæ–‡ä»¶å¤±è´¥: ${error.message}`))
      }
    }
    
    reader.onerror = () => {
      reject(new Error('è¯»å–æ–‡ä»¶å¤±è´¥'))
    }
    
    reader.readAsArrayBuffer(file)
  })
}

async function startImport() {
  if (!selectedFile.value) return
  
  importing.value = true
  importResult.value = null
  
  try {
    let items: UnifiedImportItem[]
    
    const fileName = selectedFile.value.name.toLowerCase()
    if (fileName.endsWith('.csv')) {
      const csvText = await readFileAsText(selectedFile.value)
      items = parseCSV(csvText)
    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
      items = await parseExcel(selectedFile.value)
    } else {
      throw new Error('ä¸æ”¯æŒçš„æ–‡ä»¶æ ¼å¼')
    }
    
    const result = await adminService.unifiedImport(items)
    importResult.value = result
    
    if (result.success_count > 0) {
      toast.success(`æˆåŠŸå¯¼å…¥ ${result.success_count} æ¡æ•°æ®`)
      emit('success')
    }
    
    if (result.error_count > 0) {
      toast.warning(`${result.error_count} æ¡æ•°æ®å¯¼å…¥å¤±è´¥`)
    }
    
  } catch (error: any) {
    console.error('Failed to import:', error)
    toast.error(error.message || error.response?.data?.detail || 'å¯¼å…¥å¤±è´¥')
  } finally {
    importing.value = false
  }
}
</script>
