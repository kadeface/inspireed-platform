<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QA Cell 测试页面</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div id="app">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold mb-8 text-center">QA Cell 功能测试</h1>
            
            <!-- 测试控制面板 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">测试控制面板</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">API基础URL:</label>
                        <input 
                            v-model="apiBaseUrl" 
                            type="text" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="http://localhost:8000/api/v1"
                        >
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">认证Token:</label>
                        <input 
                            v-model="authToken" 
                            type="text" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                            placeholder="Bearer your-token-here"
                        >
                    </div>
                </div>
                <div class="mt-4 flex gap-2">
                    <button 
                        @click="createTestCell" 
                        :disabled="isLoading"
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50"
                    >
                        创建测试Cell
                    </button>
                    <button 
                        @click="loadTestCell" 
                        :disabled="isLoading"
                        class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50"
                    >
                        加载测试Cell
                    </button>
                    <button 
                        @click="clearResults" 
                        class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600"
                    >
                        清除结果
                    </button>
                </div>
            </div>

            <!-- 测试结果 -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold mb-4">测试结果</h2>
                <div v-if="testResults.length === 0" class="text-gray-500 text-center py-8">
                    暂无测试结果
                </div>
                <div v-else class="space-y-4">
                    <div 
                        v-for="(result, index) in testResults" 
                        :key="index"
                        :class="[
                            'p-4 rounded-lg border-l-4',
                            result.success ? 'bg-green-50 border-green-400' : 'bg-red-50 border-red-400'
                        ]"
                    >
                        <div class="flex items-center justify-between">
                            <h3 class="font-medium">{{ result.test }}</h3>
                            <span :class="[
                                'px-2 py-1 rounded text-xs',
                                result.success ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                            ]">
                                {{ result.success ? '成功' : '失败' }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ result.message }}</p>
                        <pre v-if="result.data" class="mt-2 text-xs bg-gray-100 p-2 rounded overflow-x-auto">{{ JSON.stringify(result.data, null, 2) }}</pre>
                    </div>
                </div>
            </div>

            <!-- QA Cell 模拟器 -->
            <div v-if="testCell" class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">QA Cell 模拟器</h2>
                <div class="border border-gray-200 rounded-lg p-4">
                    <h3 class="text-lg font-semibold mb-3">{{ testCell.title || '问答互动' }}</h3>
                    
                    <!-- 问题显示区域 -->
                    <div v-if="testCell.content.question" class="question-area mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm font-medium text-gray-700">问题:</div>
                            <div class="flex gap-2">
                                <button
                                    @click="askAI"
                                    :disabled="isAsking"
                                    class="text-xs px-2 py-1 bg-green-500 text-white hover:bg-green-600 rounded disabled:opacity-50"
                                >
                                    问AI
                                </button>
                            </div>
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            {{ testCell.content.question }}
                        </div>
                    </div>

                    <!-- 回答显示区域 -->
                    <div v-if="testCell.content.answer" class="answer-area mb-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="text-sm font-medium text-gray-700 flex items-center gap-2">
                                回答 {{ testCell.content.isAIAnswer ? '(AI)' : '' }}:
                                <span v-if="testCell.content.isAIAnswer && aiConfidence" class="text-xs text-gray-500">
                                    (置信度: {{ Math.round(aiConfidence * 100) }}%)
                                </span>
                            </div>
                        </div>
                        <div class="bg-green-50 p-3 rounded-lg">
                            <div v-html="formattedAnswer"></div>
                        </div>
                    </div>

                    <!-- 问题输入区域 -->
                    <div v-if="!testCell.content.question" class="input-area">
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">输入问题:</label>
                            <textarea
                                v-model="questionInput"
                                placeholder="输入你的问题..."
                                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="3"
                            ></textarea>
                        </div>
                        
                        <div class="flex gap-2">
                            <button
                                @click="submitQuestion(false)"
                                :disabled="!questionInput.trim() || isAsking"
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                提交给教师
                            </button>
                            <button
                                @click="submitQuestion(true)"
                                :disabled="!questionInput.trim() || isAsking"
                                class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed"
                            >
                                <span v-if="isAsking">AI思考中...</span>
                                <span v-else>问AI</span>
                            </button>
                        </div>
                    </div>

                    <!-- 加载状态 -->
                    <div v-if="isAsking" class="loading-area mt-4 p-4 bg-yellow-50 rounded-lg">
                        <div class="flex items-center gap-2">
                            <div class="animate-spin h-4 w-4 border-2 border-yellow-600 border-t-transparent rounded-full"></div>
                            <span class="text-sm text-yellow-700">AI正在思考中，请稍候...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const apiBaseUrl = ref('http://localhost:8000/api/v1');
                const authToken = ref('');
                const testResults = ref([]);
                const testCell = ref(null);
                const questionInput = ref('');
                const isAsking = ref(false);
                const aiConfidence = ref(null);

                const formattedAnswer = computed(() => {
                    if (!testCell.value?.content.answer) return '';
                    
                    return testCell.value.content.answer
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')
                        .replace(/```([\s\S]*?)```/g, '<pre class="bg-gray-100 p-2 rounded text-sm"><code>$1</code></pre>')
                        .replace(/`(.*?)`/g, '<code class="bg-gray-100 px-1 rounded text-sm">$1</code>')
                        .replace(/\n/g, '<br>');
                });

                const addTestResult = (test, success, message, data = null) => {
                    testResults.value.push({
                        test,
                        success,
                        message,
                        data,
                        timestamp: new Date().toLocaleTimeString()
                    });
                };

                const makeRequest = async (method, url, data = null) => {
                    const config = {
                        method,
                        url: apiBaseUrl.value + url,
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    };

                    if (authToken.value) {
                        config.headers['Authorization'] = authToken.value;
                    }

                    if (data) {
                        config.data = data;
                    }

                    try {
                        const response = await axios(config);
                        return { success: true, data: response.data, status: response.status };
                    } catch (error) {
                        return { 
                            success: false, 
                            error: error.response?.data || error.message, 
                            status: error.response?.status 
                        };
                    }
                };

                const createTestCell = async () => {
                    addTestResult('创建测试Cell', true, '开始创建测试Cell...');
                    
                    const testData = {
                        lesson_id: 1,
                        cell_type: 'qa',
                        title: '测试QA Cell',
                        content: {
                            question: '',
                            answer: '',
                            isAIAnswer: false
                        },
                        config: {},
                        order: 0,
                        editable: true
                    };

                    const result = await makeRequest('POST', '/cells/', testData);
                    
                    if (result.success) {
                        testCell.value = result.data;
                        addTestResult('创建测试Cell', true, `Cell创建成功，ID: ${result.data.id}`, result.data);
                    } else {
                        addTestResult('创建测试Cell', false, `创建失败: ${result.error}`, result.error);
                    }
                };

                const loadTestCell = async () => {
                    if (!testCell.value?.id) {
                        addTestResult('加载测试Cell', false, '请先创建测试Cell');
                        return;
                    }

                    addTestResult('加载测试Cell', true, '开始加载测试Cell...');
                    
                    const result = await makeRequest('GET', `/cells/${testCell.value.id}`);
                    
                    if (result.success) {
                        testCell.value = result.data;
                        addTestResult('加载测试Cell', true, 'Cell加载成功', result.data);
                    } else {
                        addTestResult('加载测试Cell', false, `加载失败: ${result.error}`, result.error);
                    }
                };

                const submitQuestion = async (askAI = false) => {
                    if (!questionInput.value.trim()) return;
                    
                    isAsking.value = true;
                    addTestResult('提交问题', true, `开始提交问题: ${askAI ? '问AI' : '提交给教师'}`);
                    
                    try {
                        const data = {
                            question: questionInput.value,
                            ask_ai: askAI
                        };

                        const result = await makeRequest('POST', `/cells/${testCell.value.id}/ask`, data);
                        
                        if (result.success) {
                            testCell.value.content.question = questionInput.value;
                            testCell.value.content.answer = result.data.answer;
                            testCell.value.content.isAIAnswer = result.data.is_ai_answer;
                            
                            if (result.data.confidence) {
                                aiConfidence.value = result.data.confidence;
                            }
                            
                            addTestResult('提交问题', true, '问题提交成功', result.data);
                            questionInput.value = '';
                        } else {
                            addTestResult('提交问题', false, `提交失败: ${result.error}`, result.error);
                        }
                    } catch (error) {
                        addTestResult('提交问题', false, `提交异常: ${error.message}`);
                    } finally {
                        isAsking.value = false;
                    }
                };

                const askAI = async () => {
                    if (!testCell.value.content.question) return;
                    
                    isAsking.value = true;
                    addTestResult('AI问答', true, '开始AI问答...');
                    
                    try {
                        const data = {
                            question: testCell.value.content.question,
                            ask_ai: true
                        };

                        const result = await makeRequest('POST', `/cells/${testCell.value.id}/ask`, data);
                        
                        if (result.success) {
                            testCell.value.content.answer = result.data.answer;
                            testCell.value.content.isAIAnswer = result.data.is_ai_answer;
                            
                            if (result.data.confidence) {
                                aiConfidence.value = result.data.confidence;
                            }
                            
                            addTestResult('AI问答', true, 'AI问答成功', result.data);
                        } else {
                            addTestResult('AI问答', false, `AI问答失败: ${result.error}`, result.error);
                        }
                    } catch (error) {
                        addTestResult('AI问答', false, `AI问答异常: ${error.message}`);
                    } finally {
                        isAsking.value = false;
                    }
                };

                const clearResults = () => {
                    testResults.value = [];
                    testCell.value = null;
                    questionInput.value = '';
                    isAsking.value = false;
                    aiConfidence.value = null;
                };

                return {
                    apiBaseUrl,
                    authToken,
                    testResults,
                    testCell,
                    questionInput,
                    isAsking,
                    aiConfidence,
                    formattedAnswer,
                    createTestCell,
                    loadTestCell,
                    submitQuestion,
                    askAI,
                    clearResults
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
