<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€Šå¼€å¹³é•¿å¸ˆé™„å±å°å­¦æŠ½è±¡æ•°å­¦å¯è§†åŒ–æ¢ç©¶ã€‹ - æ’é˜Ÿé—®é¢˜ï¼šä»å‰å¾€åæ•°ä¸ä»åå¾€å‰æ•°</title>
    <style>
        :root {
            --primary-background: #FFFFFF;
            --text-color: #000000;
            --border-color: #E0E0E0;
            --main-color: #FF6600;
            --main-color-light: #FF9933;
            --accent-color: #4CAF50;
            --error-color: #D32F2F;
            --aiddy-color: #ff6b6b;
            --dakuan-color: #1565C0;
            --between-color: #95e1d3;
            --other-color: #ffe66d;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--primary-background);
            color: var(--text-color);
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            line-height: 1.6;
        }

        header {
            background: linear-gradient(135deg, var(--main-color), var(--main-color-light));
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        header h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        header h2 {
            font-size: 1.2em;
            font-weight: normal;
            opacity: 0.95;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        #visualization-area {
            display: flex;
            gap: 20px;
            min-height: 600px;
            margin-bottom: 30px;
        }

        .left-panel {
            flex: 0 0 60%;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .left-panel h3 {
            color: var(--main-color);
            margin-bottom: 15px;
            text-align: center;
        }

        #scene-container {
            width: 100%;
            height: 500px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            position: relative;
            background: linear-gradient(to bottom, #e3f2fd 0%, #f5f5f5 100%);
        }

        .right-panel {
            flex: 0 0 38%;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .right-panel h3 {
            color: var(--main-color);
            margin-bottom: 15px;
            text-align: center;
        }

        #logic-diagram {
            width: 100%;
            height: 500px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: #fafafa;
        }

        #control-panel {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .control-group {
            margin-bottom: 25px;
        }

        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 1.1em;
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 5px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--main-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--main-color-light);
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--main-color);
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .value-display {
            min-width: 80px;
            padding: 8px 15px;
            background: var(--accent-color);
            color: white;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        button.primary {
            background: var(--main-color);
            color: white;
        }

        button.primary:hover {
            background: var(--main-color-light);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        button.secondary {
            background: var(--accent-color);
            color: white;
        }

        button.secondary:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        #instructions {
            background: #fff3e0;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #instructions h3 {
            color: var(--main-color);
            margin-bottom: 15px;
        }

        #instructions p {
            margin-bottom: 10px;
            font-size: 1.05em;
        }

        #feedback {
            background: white;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            min-height: 80px;
            font-size: 1.1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        #feedback.success {
            background: #e8f5e9;
            border-color: var(--accent-color);
            color: var(--accent-color);
        }

        #feedback.info {
            background: #e3f2fd;
            border-color: #2196F3;
            color: #1976D2;
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95em;
        }

        .legend-color {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .rotate-hint {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
            pointer-events: none;
            z-index: 10;
        }

        .loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: var(--main-color);
            font-size: 1.2em;
            font-weight: bold;
        }

        @media (max-width: 1200px) {
            #visualization-area {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                flex: 1 1 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ã€Šå¼€å¹³é•¿å¸ˆé™„å±å°å­¦æŠ½è±¡æ•°å­¦å¯è§†åŒ–æ¢ç©¶ã€‹</h1>
        <h2>æ’é˜Ÿé—®é¢˜ï¼šä»å‰å¾€åæ•°ä¸ä»åå¾€å‰æ•°</h2>
    </header>

    <div class="container">
        <div id="instructions">
            <h3>ğŸ“š é—®é¢˜æè¿°</h3>
            <p><strong>å°æœ‹å‹ä»¬æ’æˆä¸€é˜Ÿï¼š</strong></p>
            <p>â€¢ ä»å‰å¾€åæ•°ï¼Œ<span style="color: #ff6b6b; font-weight: bold;">è‰¾è¿ªæ˜¯ç¬¬8ä¸ª</span></p>
            <p>â€¢ ä»åå¾€å‰æ•°ï¼Œ<span style="color: #1565C0; font-weight: bold;">å¤§å®½æ˜¯ç¬¬9ä¸ª</span></p>
            <p>â€¢ å·²çŸ¥è‰¾è¿ªåœ¨å¤§å®½çš„å‰é¢ï¼Œ<span style="color: #95e1d3; font-weight: bold;">ä»–ä»¬ä¹‹é—´æœ‰6äºº</span></p>
            <p><strong style="color: #FF6600;">é—®ï¼šæ’é˜Ÿçš„ä¸€å…±æœ‰å¤šå°‘äººï¼Ÿ</strong></p>
            <h3>ğŸ® æ“ä½œè¯´æ˜</h3>
            <p>â€¢ æ‹–åŠ¨æ»‘å—è°ƒæ•´å‚æ•°ï¼Œè§‚å¯Ÿ3Dåœºæ™¯ä¸­çš„å˜åŒ–</p>
            <p>â€¢ ç”¨é¼ æ ‡æ‹–åŠ¨å·¦ä¾§3Dåœºæ™¯å¯ä»¥æ—‹è½¬è§†è§’ï¼Œæ»šè½®å¯ä»¥ç¼©æ”¾</p>
            <p>â€¢ æ³¨æ„è§‚å¯Ÿï¼šçº¢è‰²è‰¾è¿ªã€æ·±è“è‰²å¤§å®½ã€ç»¿è‰²è¿çº¿è¡¨ç¤ºä¸­é—´6äºº</p>
        </div>

        <div id="control-panel">
            <div class="control-group">
                <label>ä»å‰å¾€åæ•°ï¼Œè‰¾è¿ªæ˜¯ç¬¬å‡ ä¸ªï¼Ÿ</label>
                <div class="slider-container">
                    <input type="range" id="aiddy-slider" min="1" max="20" value="8">
                    <div class="value-display" id="aiddy-value">ç¬¬ 8 ä¸ª</div>
                </div>
            </div>

            <div class="control-group">
                <label>ä»åå¾€å‰æ•°ï¼Œå¤§å®½æ˜¯ç¬¬å‡ ä¸ªï¼Ÿ</label>
                <div class="slider-container">
                    <input type="range" id="dakuan-slider" min="1" max="20" value="9">
                    <div class="value-display" id="dakuan-value">ç¬¬ 9 ä¸ª</div>
                </div>
            </div>

            <div class="control-group">
                <label>è‰¾è¿ªå’Œå¤§å®½ä¹‹é—´æœ‰å‡ äººï¼Ÿï¼ˆå›ºå®šä¸º6äººï¼‰</label>
                <div class="slider-container">
                    <input type="range" id="between-slider" min="0" max="15" value="6" disabled style="opacity: 0.5;">
                    <div class="value-display" style="background: #95e1d3;">6 äºº</div>
                </div>
            </div>

            <div class="button-group">
                <button class="primary" onclick="resetParameters()">ğŸ”„ é‡ç½®å‚æ•°</button>
                <button class="secondary" onclick="showAnswer()">ğŸ’¡ æ˜¾ç¤ºç­”æ¡ˆ</button>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>è‰¾è¿ªï¼ˆä»å‰æ•°ç¬¬8ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1565C0;"></div>
                    <span>å¤§å®½ï¼ˆä»åæ•°ç¬¬9ï¼‰</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #95e1d3;"></div>
                    <span>ä¸­é—´6äºº</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffe66d;"></div>
                    <span>å…¶ä»–äºº</span>
                </div>
            </div>
        </div>

        <div id="visualization-area">
            <div class="left-panel">
                <h3>ğŸ¬ 3D æ’é˜Ÿåœºæ™¯ï¼ˆæ–‡å­—â†’å›¾ç¤ºï¼‰</h3>
                <div id="scene-container">
                    <div class="loading-message">æ­£åœ¨åŠ è½½3Dåœºæ™¯...</div>
                    <div class="rotate-hint">ğŸ’¡ æ‹–åŠ¨æ—‹è½¬ | æ»šè½®ç¼©æ”¾</div>
                </div>
            </div>

            <div class="right-panel">
                <h3>ğŸ§® é€»è¾‘æ¨ç†æµç¨‹</h3>
                <svg id="logic-diagram" viewBox="0 0 500 500"></svg>
            </div>
        </div>

        <div id="feedback"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <script>
        let scene, camera, renderer, controls;
        let people = [];
        let arrows = [];
        let annotations = [];
        let aiddyPosition = 8;
        let dakuanPosition = 9;
        const betweenCount = 6;

        const AIDDY_COLOR = 0xff6b6b;
        const DAKUAN_COLOR = 0x1565C0;
        const BETWEEN_COLOR = 0x95e1d3;
        const OTHER_COLOR = 0xffe66d;

        function initThreeJS() {
            try {
                const container = document.getElementById('scene-container');
                const loadingMsg = container.querySelector('.loading-message');
                if (loadingMsg) loadingMsg.remove();
                
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xe3f2fd);
                
                const width = container.clientWidth;
                const height = container.clientHeight;
                camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 1000);
                camera.position.set(0, 18, 35);
                camera.lookAt(0, 0, 0);
                
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(width, height);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                container.appendChild(renderer.domElement);
                
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                controls.maxPolarAngle = Math.PI / 2;
                controls.minDistance = 15;
                controls.maxDistance = 70;
                
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 20, 10);
                directionalLight.castShadow = true;
                directionalLight.shadow.camera.left = -40;
                directionalLight.shadow.camera.right = 40;
                directionalLight.shadow.camera.top = 40;
                directionalLight.shadow.camera.bottom = -40;
                scene.add(directionalLight);
                
                const groundGeometry = new THREE.PlaneGeometry(100, 20);
                const groundMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xcccccc,
                    roughness: 0.8
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                scene.add(ground);
                
                window.addEventListener('resize', () => {
                    const width = container.clientWidth;
                    const height = container.clientHeight;
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                });
                
                console.log('Three.js åˆå§‹åŒ–æˆåŠŸ');
                createPeople();
                animate();
                
            } catch (error) {
                console.error('Three.js åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        function createPersonModel(color) {
            const group = new THREE.Group();
            
            const bodyGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1.2, 8);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: color });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.6;
            body.castShadow = true;
            body.receiveShadow = true;
            group.add(body);
            
            const headGeometry = new THREE.SphereGeometry(0.4, 16, 16);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0xffdbac });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 1.5;
            head.castShadow = true;
            head.receiveShadow = true;
            group.add(head);
            
            const eyeGeometry = new THREE.SphereGeometry(0.08, 8, 8);
            const eyeMaterial = new THREE.MeshStandardMaterial({ color: 0x000000 });
            
            const leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.15, 1.55, 0.35);
            group.add(leftEye);
            
            const rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.15, 1.55, 0.35);
            group.add(rightEye);
            
            const smileGeometry = new THREE.TorusGeometry(0.15, 0.03, 8, 16, Math.PI);
            const smileMaterial = new THREE.MeshStandardMaterial({ color: 0xff6b6b });
            const smile = new THREE.Mesh(smileGeometry, smileMaterial);
            smile.position.set(0, 1.35, 0.35);
            smile.rotation.x = Math.PI;
            group.add(smile);
            
            return group;
        }

        function createNumberLabel(number) {
            const canvas = document.createElement('canvas');
            canvas.width = 128;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#FFFFFF';
            ctx.beginPath();
            ctx.arc(64, 64, 58, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.strokeStyle = '#FF6600';
            ctx.lineWidth = 8;
            ctx.beginPath();
            ctx.arc(64, 64, 58, 0, Math.PI * 2);
            ctx.stroke();
            
            ctx.fillStyle = '#000000';
            ctx.font = 'bold 64px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(number.toString(), 64, 68);
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            
            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(1, 1, 1);
            
            return sprite;
        }

        function createTextLabel(text, color = '#000000', bgColor = '#FFFFFF') {
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 128;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = color;
            ctx.lineWidth = 6;
            ctx.strokeRect(3, 3, canvas.width - 6, canvas.height - 6);
            
            ctx.fillStyle = color;
            ctx.font = 'bold 48px Microsoft YaHei, Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, canvas.width / 2, canvas.height / 2);
            
            const texture = new THREE.CanvasTexture(canvas);
            texture.needsUpdate = true;
            
            const spriteMaterial = new THREE.SpriteMaterial({ 
                map: texture,
                transparent: true
            });
            const sprite = new THREE.Sprite(spriteMaterial);
            sprite.scale.set(4, 1, 1);
            
            return sprite;
        }

        function createPeople() {
            people.forEach(person => scene.remove(person));
            people = [];
            
            arrows.forEach(arrow => scene.remove(arrow));
            arrows = [];
            
            annotations.forEach(annotation => scene.remove(annotation));
            annotations = [];
            
            const totalPeople = calculateTotalPeople();
            const dakuanActualPosition = totalPeople - dakuanPosition + 1;
            
            const spacing = 2.5;
            const totalWidth = (totalPeople - 1) * spacing;
            
            // åˆ›å»ºäººç‰©
            for (let i = 1; i <= totalPeople; i++) {
                let color;
                
                if (i === aiddyPosition) {
                    color = AIDDY_COLOR;
                } else if (i === dakuanActualPosition) {
                    color = DAKUAN_COLOR;
                } else if (i > aiddyPosition && i < dakuanActualPosition) {
                    color = BETWEEN_COLOR;
                } else {
                    color = OTHER_COLOR;
                }
                
                const person = createPersonModel(color);
                const x = -totalWidth / 2 + (i - 1) * spacing;
                person.position.set(x, 0, 0);
                
                const numberLabel = createNumberLabel(i);
                numberLabel.position.set(0, 2.8, 0);
                person.add(numberLabel);
                
                scene.add(person);
                people.push(person);
            }
            
            // è‰¾è¿ªæ ‡ç­¾
            const aiddyLabel = createTextLabel('è‰¾è¿ª', '#ff6b6b', '#ffe0e0');
            const aiddyX = -totalWidth / 2 + (aiddyPosition - 1) * spacing;
            aiddyLabel.position.set(aiddyX, 4.5, 0);
            scene.add(aiddyLabel);
            annotations.push(aiddyLabel);
            
            // å¤§å®½æ ‡ç­¾
            const dakuanLabel = createTextLabel('å¤§å®½', '#1565C0', '#E3F2FD');
            const dakuanX = -totalWidth / 2 + (dakuanActualPosition - 1) * spacing;
            dakuanLabel.position.set(dakuanX, 4.5, 0);
            scene.add(dakuanLabel);
            annotations.push(dakuanLabel);
            
            // ä¸­é—´6äººè¿çº¿
            if (dakuanActualPosition > aiddyPosition + 1) {
                const betweenStartX = -totalWidth / 2 + aiddyPosition * spacing;
                const betweenEndX = -totalWidth / 2 + (dakuanActualPosition - 2) * spacing;
                
                const lineGeometry = new THREE.CylinderGeometry(0.12, 0.12, betweenEndX - betweenStartX, 8);
                const lineMaterial = new THREE.MeshStandardMaterial({ 
                    color: BETWEEN_COLOR,
                    emissive: BETWEEN_COLOR,
                    emissiveIntensity: 0.4
                });
                const line = new THREE.Mesh(lineGeometry, lineMaterial);
                line.position.set((betweenStartX + betweenEndX) / 2, 3.5, 0);
                line.rotation.z = Math.PI / 2;
                scene.add(line);
                arrows.push(line);
                
                const betweenLabel = createTextLabel(`ä¸­é—´${betweenCount}äºº`, '#2E7D32', '#f0fff0');
                betweenLabel.position.set((betweenStartX + betweenEndX) / 2, 4, 2);
                betweenLabel.scale.set(3, 0.75, 1);
                scene.add(betweenLabel);
                annotations.push(betweenLabel);
            }
            
            // ä»å‰å¾€åçš„ç®­å¤´ï¼ˆæ©™è‰²ï¼‰ - ä¿®å¤å
            createCountingArrow(
                -totalWidth / 2 - 4, 
                -2, 
                aiddyX, 
                -2, 
                0xFF6600, 
                `ä»å‰æ•°â†’ç¬¬${aiddyPosition}ä¸ª`,
                true  // ä»å·¦åˆ°å³
            );
            
            // ä»åå¾€å‰çš„ç®­å¤´ï¼ˆç»¿è‰²ï¼‰ - ä¿®å¤å
            createCountingArrow(
                totalWidth / 2 + 4, 
                -4, 
                dakuanX, 
                -4, 
                0x4CAF50, 
                `â†ä»åæ•°ç¬¬${dakuanPosition}ä¸ª`,
                false  // ä»å³åˆ°å·¦
            );
            
            console.log(`æ€»äººæ•°: ${totalPeople}, è‰¾è¿ªä½ç½®: ${aiddyPosition}, å¤§å®½ä½ç½®: ${dakuanActualPosition}`);
        }

        // ä¿®å¤åçš„ç®­å¤´åˆ›å»ºå‡½æ•°
        function createCountingArrow(x1, y1, x2, y2, color, labelText, leftToRight) {
            const group = new THREE.Group();
            
            // ç²—ç®­å¤´çº¿
            const points = [
                new THREE.Vector3(x1, y1, 2),
                new THREE.Vector3(x2, y2, 2)
            ];
            
            // ä½¿ç”¨åœ†æŸ±ä½“åˆ›å»ºæ›´ç²—çš„çº¿æ¡
            const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
            const lineGeometry = new THREE.CylinderGeometry(0.15, 0.15, distance, 8);
            const lineMaterial = new THREE.MeshStandardMaterial({ 
                color: color,
                emissive: color,
                emissiveIntensity: 0.3
            });
            const line = new THREE.Mesh(lineGeometry, lineMaterial);
            
            // å®šä½å’Œæ—‹è½¬çº¿æ¡
            line.position.set((x1 + x2) / 2, (y1 + y2) / 2, 2);
            line.rotation.z = Math.atan2(y2 - y1, x2 - x1) - Math.PI / 2;
            group.add(line);
            
            // ç®­å¤´å¤´éƒ¨ï¼ˆæ›´å¤§æ›´æ˜æ˜¾ï¼‰
            const arrowGeometry = new THREE.ConeGeometry(0.5, 1.2, 8);
            const arrowMaterial = new THREE.MeshStandardMaterial({ 
                color: color,
                emissive: color,
                emissiveIntensity: 0.2
            });
            const arrowHead = new THREE.Mesh(arrowGeometry, arrowMaterial);
            arrowHead.position.set(x2, y2, 2);
            arrowHead.rotation.z = leftToRight ? -Math.PI / 2 : Math.PI / 2;
            group.add(arrowHead);
            
            // æ–‡å­—æ ‡ç­¾ï¼ˆæ›´å¤§æ›´æ¸…æ™°ï¼‰
            const label = createTextLabel(labelText, `rgb(${(color >> 16) & 255}, ${(color >> 8) & 255}, ${color & 255})`, '#FFFFFF');
            label.position.set((x1 + x2) / 2, y1 + 2, 2);
            label.scale.set(5, 1.25, 1);
            group.add(label);
            
            scene.add(group);
            arrows.push(group);
            
            console.log(`åˆ›å»ºç®­å¤´: ${labelText}, ä»(${x1},${y1})åˆ°(${x2},${y2})`);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (controls) controls.update();
            if (renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        function calculateTotalPeople() {
            return aiddyPosition + betweenCount + dakuanPosition;
        }

        function updateLogicDiagram() {
            const svg = document.getElementById('logic-diagram');
            svg.innerHTML = '';
            
            const totalPeople = calculateTotalPeople();
            const dakuanActualPosition = totalPeople - dakuanPosition + 1;
            
            const title = createSVGText(250, 30, 'æ¨ç†æµç¨‹', 'bold 18px Arial', '#FF6600', 'middle');
            svg.appendChild(title);
            
            let yPos = 65;
            
            // æ­¥éª¤1
            const step1Group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const step1Rect = createSVGRect(30, yPos - 20, 440, 95, '#fff3e0', '#FF6600', 2);
            step1Group.appendChild(step1Rect);
            
            const step1Title = createSVGText(45, yPos, 'æ­¥éª¤1ï¼šç†è§£é¢˜ç›®', 'bold 14px Arial', '#FF6600');
            step1Group.appendChild(step1Title);
            
            const step1Text1 = createSVGText(50, yPos + 22, `è‰¾è¿ªä»å‰æ•°ç¬¬ ${aiddyPosition} ä¸ª`, '13px Arial', '#ff6b6b');
            step1Group.appendChild(step1Text1);
            
            const step1Text2 = createSVGText(50, yPos + 42, `å¤§å®½ä»åæ•°ç¬¬ ${dakuanPosition} ä¸ª`, '13px Arial', '#1565C0');
            step1Group.appendChild(step1Text2);
            
            const step1Text3 = createSVGText(50, yPos + 62, `ä¸­é—´æœ‰ ${betweenCount} äºº`, '13px Arial', '#95e1d3');
            step1Group.appendChild(step1Text3);
            
            svg.appendChild(step1Group);
            yPos += 105;
            
            const arrow1 = createArrowPath(250, yPos, 250, yPos + 25, '#FF6600', 3);
            svg.appendChild(arrow1);
            yPos += 35;
            
            // æ­¥éª¤2
            const step2Group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const step2Rect = createSVGRect(30, yPos - 20, 440, 90, '#e8f5e9', '#4CAF50', 3);
            step2Group.appendChild(step2Rect);
            
            const step2Title = createSVGText(45, yPos, 'æ­¥éª¤2ï¼šè®¡ç®—æ€»æ•°', 'bold 14px Arial', '#4CAF50');
            step2Group.appendChild(step2Title);
            
            const step2Text1 = createSVGText(50, yPos + 22, 
                `æ€»äººæ•° = è‰¾è¿ª + ä¸­é—´ + å¤§å®½`, '12px Arial', '#000000');
            step2Group.appendChild(step2Text1);
            
            const step2Calc = createSVGText(50, yPos + 45, 
                `= ${aiddyPosition} + ${betweenCount} + ${dakuanPosition} = ${totalPeople}äºº`, 'bold 16px Arial', '#FF6600');
            step2Group.appendChild(step2Calc);
            
            svg.appendChild(step2Group);
            yPos += 100;
            
            const arrow2 = createArrowPath(250, yPos, 250, yPos + 25, '#4CAF50', 3);
            svg.appendChild(arrow2);
            yPos += 35;
            
            // æ­¥éª¤3
            const step3Group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            const step3Rect = createSVGRect(30, yPos - 20, 440, 95, '#e3f2fd', '#2196F3', 2);
            step3Group.appendChild(step3Rect);
            
            const step3Title = createSVGText(45, yPos, 'æ­¥éª¤3ï¼šéªŒè¯ç­”æ¡ˆ', 'bold 14px Arial', '#2196F3');
            step3Group.appendChild(step3Title);
            
            const step3Text1 = createSVGText(50, yPos + 22, 
                `âœ“ è‰¾è¿ªï¼šä½ç½®${aiddyPosition}`, '12px Arial', '#000000');
            step3Group.appendChild(step3Text1);
            
            const step3Text2 = createSVGText(50, yPos + 42, 
                `âœ“ å¤§å®½ï¼š${totalPeople}-${dakuanPosition}+1=${dakuanActualPosition}`, '12px Arial', '#000000');
            step3Group.appendChild(step3Text2);
            
            const step3Text3 = createSVGText(50, yPos + 62, 
                `âœ“ ä¸­é—´ï¼š${dakuanActualPosition}-${aiddyPosition}-1=${betweenCount}äºº`, '12px Arial', '#000000');
            step3Group.appendChild(step3Text3);
            
            svg.appendChild(step3Group);
        }

        function createSVGText(x, y, text, font, fill, anchor = 'start') {
            const textEl = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textEl.setAttribute('x', x);
            textEl.setAttribute('y', y);
            textEl.setAttribute('font-family', 'Microsoft YaHei, Arial');
            const fontSize = font.match(/(\d+)px/);
            if (fontSize) textEl.setAttribute('font-size', fontSize[1] + 'px');
            if (font.includes('bold')) textEl.setAttribute('font-weight', 'bold');
            textEl.setAttribute('fill', fill);
            textEl.setAttribute('text-anchor', anchor);
            textEl.textContent = text;
            return textEl;
        }

        function createSVGRect(x, y, width, height, fill, stroke, strokeWidth) {
            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            rect.setAttribute('x', x);
            rect.setAttribute('y', y);
            rect.setAttribute('width', width);
            rect.setAttribute('height', height);
            rect.setAttribute('fill', fill);
            rect.setAttribute('stroke', stroke);
            rect.setAttribute('stroke-width', strokeWidth);
            rect.setAttribute('rx', 8);
            return rect;
        }

        function createArrowPath(x1, y1, x2, y2, color, width) {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', x1);
            line.setAttribute('y1', y1);
            line.setAttribute('x2', x2);
            line.setAttribute('y2', y2);
            line.setAttribute('stroke', color);
            line.setAttribute('stroke-width', width);
            g.appendChild(line);
            
            const arrowSize = 6;
            const polygon = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const points = `${x2},${y2} ${x2 - arrowSize},${y2 - arrowSize} ${x2 + arrowSize},${y2 - arrowSize}`;
            polygon.setAttribute('points', points);
            polygon.setAttribute('fill', color);
            g.appendChild(polygon);
            
            return g;
        }

        function updateDisplay() {
            createPeople();
            updateLogicDiagram();
            
            const totalPeople = calculateTotalPeople();
            const feedback = document.getElementById('feedback');
            feedback.className = 'info';
            feedback.innerHTML = `
                <div>
                    <p>å½“å‰é…ç½®ï¼šè‰¾è¿ªç¬¬${aiddyPosition}ä¸ª + ä¸­é—´${betweenCount}äºº + å¤§å®½ä»åç¬¬${dakuanPosition}ä¸ª</p>
                    <p style="font-size: 1.3em; color: #FF6600; margin-top: 5px;">æ’é˜Ÿæ€»äººæ•° = ${totalPeople} äºº</p>
                </div>
            `;
        }

        document.getElementById('aiddy-slider').addEventListener('input', (e) => {
            aiddyPosition = parseInt(e.target.value);
            document.getElementById('aiddy-value').textContent = `ç¬¬ ${aiddyPosition} ä¸ª`;
            updateDisplay();
        });

        document.getElementById('dakuan-slider').addEventListener('input', (e) => {
            dakuanPosition = parseInt(e.target.value);
            document.getElementById('dakuan-value').textContent = `ç¬¬ ${dakuanPosition} ä¸ª`;
            updateDisplay();
        });

        function resetParameters() {
            aiddyPosition = 8;
            dakuanPosition = 9;
            document.getElementById('aiddy-slider').value = 8;
            document.getElementById('aiddy-value').textContent = 'ç¬¬ 8 ä¸ª';
            document.getElementById('dakuan-slider').value = 9;
            document.getElementById('dakuan-value').textContent = 'ç¬¬ 9 ä¸ª';
            updateDisplay();
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'info';
            feedback.textContent = 'å‚æ•°å·²é‡ç½®ä¸ºé»˜è®¤å€¼ï¼';
        }

        function showAnswer() {
            const totalPeople = calculateTotalPeople();
            const dakuanActualPosition = totalPeople - dakuanPosition + 1;
            
            const feedback = document.getElementById('feedback');
            feedback.className = 'success';
            feedback.innerHTML = `
                <div>
                    <p style="margin-bottom: 10px; font-size: 1.4em;">âœ¨ ç­”æ¡ˆï¼šæ’é˜Ÿæ€»äººæ•°ä¸º ${totalPeople} äºº</p>
                    <p style="font-size: 1em; font-weight: normal; line-height: 1.8;">
                        <strong>ç†è§£é¢˜ç›®ï¼š</strong><br>
                        â€¢ è‰¾è¿ªä»å‰æ•°ç¬¬${aiddyPosition}ä¸ªï¼Œè¯´æ˜è‰¾è¿ªåœ¨ä½ç½®${aiddyPosition}<br>
                        â€¢ å¤§å®½ä»åæ•°ç¬¬${dakuanPosition}ä¸ªï¼Œå¤§å®½åœ¨ä½ç½®${dakuanActualPosition}<br>
                        â€¢ ä»–ä»¬ä¹‹é—´æœ‰${betweenCount}äººï¼ˆä½ç½®${aiddyPosition+1}åˆ°${dakuanActualPosition-1}ï¼‰<br>
                        <strong>è®¡ç®—å…¬å¼ï¼š</strong>æ€»äººæ•° = ${aiddyPosition} + ${betweenCount} + ${dakuanPosition} = ${totalPeople}äºº
                    </p>
                </div>
            `;
        }

        window.addEventListener('load', () => {
            console.log('é¡µé¢åŠ è½½å®Œæˆ');
            if (typeof THREE !== 'undefined') {
                initThreeJS();
                updateLogicDiagram();
                updateDisplay();
            }
        });
    </script>
</body>
</html>