<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InspireEd è¿œç¨‹è¿æ¥æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .test-section h3 {
            margin-top: 0;
            color: #2196F3;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #45a049;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        input {
            padding: 8px;
            width: 300px;
            font-size: 14px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .code {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” InspireEd è¿œç¨‹è¿æ¥æµ‹è¯•</h1>
        
        <div class="test-section">
            <h3>1. è®¾ç½®æœåŠ¡å™¨åœ°å€</h3>
            <p>è¯·è¾“å…¥æœåŠ¡å™¨çš„IPåœ°å€ï¼ˆä»å¯åŠ¨æ—¥å¿—ä¸­è·å–ï¼Œé€šå¸¸æ˜¯ 192.168.x.xï¼‰:</p>
            <input type="text" id="serverIp" placeholder="ä¾‹å¦‚: 192.168.1.106" value="192.168.1.106">
            <button onclick="setServerIp()">è®¾ç½®</button>
            <div id="ipResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>2. æµ‹è¯•åç«¯è¿é€šæ€§</h3>
            <p>æµ‹è¯•æ˜¯å¦èƒ½è®¿é—®åç«¯API (ç«¯å£ 8000)</p>
            <button onclick="testBackend()">æµ‹è¯•åç«¯è¿æ¥</button>
            <div id="backendResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>3. æµ‹è¯•CORSé…ç½®</h3>
            <p>æµ‹è¯•è·¨åŸŸè¯·æ±‚æ˜¯å¦è¢«å…è®¸</p>
            <button onclick="testCORS()">æµ‹è¯•CORS</button>
            <div id="corsResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>4. æµ‹è¯•ç™»å½•å’Œä¿å­˜</h3>
            <p>æµ‹è¯•å®Œæ•´çš„ç™»å½•å’Œæ•°æ®ä¿å­˜æµç¨‹</p>
            <div>
                <input type="text" id="username" placeholder="ç”¨æˆ·å" value="teacher@test.com" style="width: 200px;">
                <input type="password" id="password" placeholder="å¯†ç " value="teacher123" style="width: 200px;">
            </div>
            <button onclick="testLogin()" style="margin-top: 10px;">æµ‹è¯•ç™»å½•</button>
            <button onclick="testSaveLesson()" id="saveBtn" disabled>æµ‹è¯•ä¿å­˜æ•™å­¦è®¾è®¡</button>
            <div id="loginResult" class="result" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>5. è¯Šæ–­ä¿¡æ¯</h3>
            <button onclick="showDiagnostics()">æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯</button>
            <div id="diagnostics" class="result info" style="display:none;"></div>
        </div>

        <div class="test-section">
            <h3>ğŸ“ ä¿®å¤å»ºè®®</h3>
            <div id="suggestions" style="display:none;">
                <div class="warning">
                    <h4>å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œè¯·å°è¯•ä»¥ä¸‹æ­¥éª¤ï¼š</h4>
                    <ol>
                        <li><strong>æ£€æŸ¥ç½‘ç»œè¿æ¥</strong>: ç¡®ä¿ä¸¤å°ç”µè„‘åœ¨åŒä¸€WiFiç½‘ç»œ</li>
                        <li><strong>æ£€æŸ¥é˜²ç«å¢™</strong>: 
                            <ul>
                                <li>macOS: ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ é˜²ç«å¢™ â†’ å…è®¸Python</li>
                                <li>Windows: æ§åˆ¶é¢æ¿ â†’ é˜²ç«å¢™ â†’ å…è®¸åº”ç”¨é€šè¿‡é˜²ç«å¢™</li>
                            </ul>
                        </li>
                        <li><strong>ç¡®è®¤æœåŠ¡å™¨IP</strong>: åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ <code>./diagnose-network.sh</code></li>
                        <li><strong>é‡å¯æœåŠ¡</strong>: åœ¨æœåŠ¡å™¨ä¸Šè¿è¡Œ <code>./restart.sh</code></li>
                        <li><strong>æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£</strong>: docs/network/TEACHER_STORAGE_ISSUE.md</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <script>
        let serverIp = '192.168.1.106';
        let authToken = null;

        function setServerIp() {
            const input = document.getElementById('serverIp').value.trim();
            if (!input) {
                showResult('ipResult', 'error', 'è¯·è¾“å…¥æœ‰æ•ˆçš„IPåœ°å€');
                return;
            }
            serverIp = input;
            showResult('ipResult', 'success', `æœåŠ¡å™¨åœ°å€å·²è®¾ç½®ä¸º: ${serverIp}`);
            document.getElementById('suggestions').style.display = 'block';
        }

        function showResult(elementId, type, message) {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.innerHTML = message;
            element.style.display = 'block';
        }

        async function testBackend() {
            showResult('backendResult', 'info', 'æ­£åœ¨æµ‹è¯•åç«¯è¿æ¥...');
            
            try {
                const response = await fetch(`http://${serverIp}:8000/health`, {
                    method: 'GET',
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('backendResult', 'success', 
                        `âœ… åç«¯è¿æ¥æˆåŠŸï¼<br>å“åº”: ${JSON.stringify(data)}<br>URL: http://${serverIp}:8000/health`);
                } else {
                    showResult('backendResult', 'error', 
                        `âŒ åç«¯è¿”å›é”™è¯¯: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                showResult('backendResult', 'error', 
                    `âŒ æ— æ³•è¿æ¥åˆ°åç«¯<br>é”™è¯¯: ${error.message}<br><br>
                    å¯èƒ½åŸå› :<br>
                    1. æœåŠ¡å™¨IPåœ°å€ä¸æ­£ç¡®<br>
                    2. åç«¯æœåŠ¡æœªè¿è¡Œ<br>
                    3. é˜²ç«å¢™é˜»æ­¢äº†è¿æ¥<br>
                    4. ä¸åœ¨åŒä¸€å±€åŸŸç½‘`);
            }
        }

        async function testCORS() {
            showResult('corsResult', 'info', 'æ­£åœ¨æµ‹è¯•CORSé…ç½®...');
            
            try {
                const response = await fetch(`http://${serverIp}:8000/api/v1/health`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    showResult('corsResult', 'success', 
                        `âœ… CORSé…ç½®æ­£ç¡®ï¼è·¨åŸŸè¯·æ±‚è¢«å…è®¸<br>
                        è¿™æ„å‘³ç€ä»å…¶ä»–ç”µè„‘è®¿é—®æ—¶ï¼Œæµè§ˆå™¨ä¸ä¼šé˜»æ­¢APIè¯·æ±‚`);
                } else {
                    showResult('corsResult', 'warning', 
                        `âš ï¸ è¯·æ±‚æˆåŠŸä½†è¿”å›: ${response.status}<br>
                        è¿™å¯èƒ½æ˜¯æ­£å¸¸çš„ï¼Œå…·ä½“å–å†³äºç«¯ç‚¹å®ç°`);
                }
            } catch (error) {
                if (error.message.includes('CORS')) {
                    showResult('corsResult', 'error', 
                        `âŒ CORSé”™è¯¯ï¼<br>
                        é”™è¯¯: ${error.message}<br><br>
                        è§£å†³æ–¹æ³•:<br>
                        1. ç¡®ä¿åç«¯ ALLOW_LAN_ACCESS=true<br>
                        2. æ£€æŸ¥ backend/app/core/config.py ä¸­çš„ CORS é…ç½®<br>
                        3. é‡å¯åç«¯æœåŠ¡: ./restart.sh`);
                } else {
                    showResult('corsResult', 'error', `âŒ æµ‹è¯•å¤±è´¥: ${error.message}`);
                }
            }
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (!username || !password) {
                showResult('loginResult', 'error', 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }

            showResult('loginResult', 'info', 'æ­£åœ¨æµ‹è¯•ç™»å½•...');
            
            try {
                const formData = new URLSearchParams();
                formData.append('username', username);
                formData.append('password', password);
                
                const response = await fetch(`http://${serverIp}:8000/api/v1/auth/login`, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    document.getElementById('saveBtn').disabled = false;
                    showResult('loginResult', 'success', 
                        `âœ… ç™»å½•æˆåŠŸï¼<br>
                        ç”¨æˆ·: ${username}<br>
                        Tokenå·²ä¿å­˜ï¼Œç°åœ¨å¯ä»¥æµ‹è¯•ä¿å­˜æ•™å­¦è®¾è®¡`);
                } else {
                    const errorData = await response.json();
                    showResult('loginResult', 'error', 
                        `âŒ ç™»å½•å¤±è´¥: ${errorData.detail || response.statusText}<br>
                        çŠ¶æ€ç : ${response.status}`);
                }
            } catch (error) {
                showResult('loginResult', 'error', 
                    `âŒ ç™»å½•è¯·æ±‚å¤±è´¥<br>é”™è¯¯: ${error.message}`);
            }
        }

        async function testSaveLesson() {
            if (!authToken) {
                showResult('loginResult', 'error', 'è¯·å…ˆç™»å½•');
                return;
            }

            showResult('loginResult', 'info', 'æ­£åœ¨æµ‹è¯•ä¿å­˜æ•™å­¦è®¾è®¡...');
            
            try {
                // æµ‹è¯•è·å–è¯¾ç¨‹åˆ—è¡¨ï¼ˆéœ€è¦è®¤è¯çš„è¯·æ±‚ï¼‰
                const response = await fetch(`http://${serverIp}:8000/api/v1/lessons/?page=1&page_size=1`, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showResult('loginResult', 'success', 
                        `âœ… ä¿å­˜åŠŸèƒ½æ­£å¸¸ï¼<br>
                        æˆåŠŸè·å–æ•™å­¦è®¾è®¡åˆ—è¡¨<br>
                        æ€»æ•°: ${data.total}<br>
                        è¿™æ„å‘³ç€ä»å…¶ä»–ç”µè„‘å¯ä»¥æ­£å¸¸ä¿å­˜æ•™å­¦è®¾è®¡`);
                } else {
                    const errorData = await response.json();
                    showResult('loginResult', 'error', 
                        `âŒ ä¿å­˜æµ‹è¯•å¤±è´¥: ${errorData.detail || response.statusText}<br>
                        çŠ¶æ€ç : ${response.status}`);
                }
            } catch (error) {
                showResult('loginResult', 'error', 
                    `âŒ ä¿å­˜è¯·æ±‚å¤±è´¥<br>é”™è¯¯: ${error.message}<br><br>
                    è¿™å¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–CORSé…ç½®é—®é¢˜`);
            }
        }

        function showDiagnostics() {
            const info = `
                <h4>è¯Šæ–­ä¿¡æ¯</h4>
                <div class="code">
                å½“å‰é¡µé¢URL: ${window.location.href}<br>
                æœåŠ¡å™¨IP: ${serverIp}<br>
                åç«¯APIåœ°å€: http://${serverIp}:8000/api/v1<br>
                å‰ç«¯è®¿é—®åœ°å€: http://${serverIp}:5173<br>
                è®¤è¯çŠ¶æ€: ${authToken ? 'å·²ç™»å½•' : 'æœªç™»å½•'}<br>
                æµè§ˆå™¨: ${navigator.userAgent}
                </div>
                
                <h4>æ¨èçš„è®¿é—®åœ°å€</h4>
                <div class="code">
                <strong>ä»å…¶ä»–ç”µè„‘è®¿é—®å‰ç«¯:</strong><br>
                <a href="http://${serverIp}:5173" target="_blank">http://${serverIp}:5173</a><br><br>
                
                <strong>åç«¯APIæ–‡æ¡£:</strong><br>
                <a href="http://${serverIp}:8000/docs" target="_blank">http://${serverIp}:8000/docs</a><br><br>
                
                <strong>å¥åº·æ£€æŸ¥:</strong><br>
                <a href="http://${serverIp}:8000/health" target="_blank">http://${serverIp}:8000/health</a>
                </div>
            `;
            
            showResult('diagnostics', 'info', info);
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è®¾ç½®IP
        window.onload = function() {
            const currentHost = window.location.hostname;
            if (currentHost !== 'localhost' && currentHost !== '127.0.0.1') {
                document.getElementById('serverIp').value = currentHost;
                serverIp = currentHost;
                showResult('ipResult', 'info', `è‡ªåŠ¨æ£€æµ‹åˆ°æœåŠ¡å™¨IP: ${serverIp}`);
            }
            document.getElementById('suggestions').style.display = 'block';
        }
    </script>
</body>
</html>

